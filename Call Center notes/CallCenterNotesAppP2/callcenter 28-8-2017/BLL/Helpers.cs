using CallCenterNotesApp.CustomExceptions;
using CallCenterNotesApp.DLL;
using CallCenterNotesApp.ModelView;
using System;
using System.Collections.Generic;
using System.Data;
using System.IO;
using System.Linq;
using System.Net.NetworkInformation;
using System.Web;
using static CallCenterNotesApp.Enums.Enums;
using System.Data.SqlClient;
using ClosedXML.Excel;
using System.Configuration;
using System.Transactions;

namespace CallCenterNotesApp.BLL
{
    public class Helpers
    {
        protected Mailing SendEmail;
        protected CallcentereMailRequest Model;
        public Helpers()
        {
            SendEmail = new Mailing();
            Model = new CallcentereMailRequest();
        }
        public List<ModelViewTable> GetUnAssignedRequestsByUserName(string UserName, string Type, string SubType, int? asc)
        {
            using (PhNetworkEntities DataContext = new PhNetworkEntities())
            {
                List<ModelViewTable> UnAssignedRequests = new List<ModelViewTable>();
                var UserType = (from t in DataContext.CallCenterAppUsers where t.UserName == UserName select t.UserType).SingleOrDefault().ToString();
                if (UserType == "CallCenterUser")
                {
                    UnAssignedRequests = (from r in Model.SearchAllRequests(Type, SubType, asc, (int)RequestStatus.NewAutoGenerated) select r).ToList();
                    return UnAssignedRequests;
                }
                if (UserType == "CallCenterDoctor")
                {
                    UnAssignedRequests = (from r in Model.SearchAllRequests(Type, SubType, asc, (int)RequestStatus.PendingDoctorsAssign) select r).ToList();
                    return UnAssignedRequests;
                }
                if (UserType == "CallCenterAuditDoctor" || UserType == "CallCenterManager")
                {
                    UnAssignedRequests = (from r in Model.SearchAllRequests(Type, SubType, asc, (int)RequestStatus.PendingAuditAssign) select r).ToList();
                    return UnAssignedRequests;
                }
                if (UserType == "Administrator")
                {
                    UnAssignedRequests = (from r in Model.SearchAllRequests(Type, SubType, asc, null)
                                          where
                                          r.RequstStatusID == (int)RequestStatus.PendingDoctorsAssign ||
                                          r.RequstStatusID == (int)RequestStatus.PendingAuditAssign ||
                                          r.RequstStatusID == (int)RequestStatus.NewAutoGenerated
                                          select r).ToList();
                    return UnAssignedRequests;
                }
                else
                {
                    return UnAssignedRequests;
                }
            }
        }
        public int GetUnAssignedRequestsByUserNameCount(string UserName)
        {
            using (PhNetworkEntities DataContext = new PhNetworkEntities())
            {
                int UnAssignedRequests = 0;
                var UserType = (from t in DataContext.CallCenterAppUsers where t.UserName == UserName select t.UserType).SingleOrDefault().ToString();
                if (UserType == "CallCenterUser")
                {
                    UnAssignedRequests = (from r in DataContext.EmailApprovalRequests where r.RequstStatusID == (int)RequestStatus.NewAutoGenerated select r.ID).Count();
                    return UnAssignedRequests;
                }
                if (UserType == "CallCenterDoctor")
                {
                    UnAssignedRequests = (from r in DataContext.EmailApprovalRequests where r.RequstStatusID == (int)RequestStatus.PendingDoctorsAssign select r.ID).Count();
                    return UnAssignedRequests;
                }
                if (UserType == "CallCenterAuditDoctor" || UserType == "CallCenterManager")
                {
                    UnAssignedRequests = (from r in DataContext.EmailApprovalRequests where r.RequstStatusID == (int)RequestStatus.PendingAuditAssign select r.ID).Count();
                    return UnAssignedRequests;
                }
                if (UserType == "Administrator")
                {
                    UnAssignedRequests = (from r in DataContext.EmailApprovalRequests
                                          where
                                          r.RequstStatusID == (int)RequestStatus.PendingDoctorsAssign ||
                                          r.RequstStatusID == (int)RequestStatus.PendingAuditAssign ||
                                          r.RequstStatusID == (int)RequestStatus.NewAutoGenerated
                                          select r.ID).Count();
                    return UnAssignedRequests;
                }
                else
                {
                    return UnAssignedRequests;
                }
            }
        }
        public List<ModelViewTable> GetAssignedTicketByUserName(string UserName, string Type, string SubType, int? asc)
        {

            using (PhNetworkEntities Db = new PhNetworkEntities())
            {
                List<ModelViewTable> AssignedRequests = new List<ModelViewTable>();
                var UserType = (from t in Db.CallCenterAppUsers where t.UserName == UserName select t.UserType).SingleOrDefault().ToString();

                if (UserType == "CallCenterUser")
                {
                    AssignedRequests = (from r in Model.SearchAllRequests(Type, SubType, asc, null) where r.OperatorAssignee == UserName && (r.RequstStatusID != (int)RequestStatus.Closed && r.RequstStatusID != (int)RequestStatus.Ignored) select r).ToList();
                    return AssignedRequests;
                }
                if (UserType == "CallCenterDoctor")
                {
                    AssignedRequests = (from r in Model.SearchAllRequests(Type, SubType, asc, null) where r.DoctorAssignee == UserName where r.RequstStatusID != (int)RequestStatus.Closed && r.RequstStatusID != (int)RequestStatus.Ignored select r).ToList();
                    return AssignedRequests;
                }
                if (UserType == "CallCenterAuditDoctor")
                {
                    AssignedRequests = (from r in Model.SearchAllRequests(Type, SubType, asc, null) where r.AuditAssignee == UserName where r.RequstStatusID != (int)RequestStatus.Closed && r.RequstStatusID != (int)RequestStatus.Ignored select r).ToList();
                    return AssignedRequests;
                }
                if (UserType == "CallCenterManager")
                {
                    AssignedRequests = (from r in Model.SearchAllRequests(Type, SubType, asc, null) where r.AuditAssignee == UserName where r.RequstStatusID != (int)RequestStatus.Closed && r.RequstStatusID != (int)RequestStatus.Ignored select r).ToList();
                    return AssignedRequests;
                }
                else
                {
                    return AssignedRequests;
                }

            }


        }
        public int GetAssignedTicketByUserNameCount(string UserName)
        {

            using (PhNetworkEntities Db = new PhNetworkEntities())
            {
                int AssignedRequestsCount = 0;
                var UserType = (from t in Db.CallCenterAppUsers where t.UserName == UserName select t.UserType).SingleOrDefault().ToString();

                if (UserType == "CallCenterUser")
                {
                    AssignedRequestsCount = (from r in Db.EmailApprovalRequests where r.OperatorAssignee == UserName && (r.RequstStatusID != (int)RequestStatus.Closed && r.RequstStatusID != (int)RequestStatus.Ignored) select r.ID).Count();
                    return AssignedRequestsCount;
                }
                if (UserType == "CallCenterDoctor")
                {
                    AssignedRequestsCount = (from r in Db.EmailApprovalRequests where r.DoctorAssignee == UserName where r.RequstStatusID != (int)RequestStatus.Closed && r.RequstStatusID != (int)RequestStatus.Ignored select r.ID).Count();
                    return AssignedRequestsCount;
                }
                if (UserType == "CallCenterAuditDoctor")
                {
                    AssignedRequestsCount = (from r in Db.EmailApprovalRequests where r.AuditAssignee == UserName where r.RequstStatusID != (int)RequestStatus.Closed && r.RequstStatusID != (int)RequestStatus.Ignored select r.ID).Count();
                    return AssignedRequestsCount;
                }
                if (UserType == "CallCenterManager")
                {
                    AssignedRequestsCount = (from r in Db.EmailApprovalRequests where r.AuditAssignee == UserName where r.RequstStatusID != (int)RequestStatus.Closed && r.RequstStatusID != (int)RequestStatus.Ignored select r.ID).Count();
                    return AssignedRequestsCount;
                }
                else
                {
                    return AssignedRequestsCount;
                }

            }


        }
        public List<ModelViewTable> GetTicketForDirectorUser(string UserName, string Type, string SubType, int? asc, int PageNumber)
        {
            try
            {

                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    List<ModelViewTable> AssignedRequests = new List<ModelViewTable>();
                    var UserType = (from t in Db.CallCenterAppUsers where t.UserName == UserName select t.UserType).SingleOrDefault().ToString();
                    if (PageNumber == 1)
                    {
                        AssignedRequests = (from r in Model.SearchAllRequests(Type, SubType, asc, (int)RequestStatus.NewAutoGenerated)


                                            select r).ToList();
                        return AssignedRequests;
                    }
                    else if (PageNumber == 2)
                    {
                        AssignedRequests = (from r in Model.SearchAllRequests(Type, SubType, asc, (int)RequestStatus.PendingDoctorsAssign)


                                            select r).ToList();
                    }
                    else if (PageNumber == 3)
                    {
                        AssignedRequests = (from r in Model.SearchAllRequests(Type, SubType, asc, (int)RequestStatus.PendingAuditAssign)

                                            select r).ToList();
                    }
                    else if (PageNumber == 4)
                    {
                        AssignedRequests = (from r in Model.SearchAllRequests(Type, SubType, asc, (int)RequestStatus.AssignedByOpeartor)


                                            select r).ToList();
                        return AssignedRequests;
                    }
                    else if (PageNumber == 5)
                    {
                        AssignedRequests = (from r in Model.SearchAllRequests(Type, SubType, asc, (int)RequestStatus.AssignedByDoctor)


                                            select r).ToList();
                        AssignedRequests.AddRange((from r in Model.SearchAllRequests(Type, SubType, asc, (int)RequestStatus.EndTechnicalApproveByDoctor)


                                                   select r).ToList());

                        AssignedRequests.AddRange((from r in Model.SearchAllRequests(Type, SubType, asc, (int)RequestStatus.PendingTechnicalApproveByDoctor)


                                                   select r).ToList());





                        return AssignedRequests;
                    }
                    else if (PageNumber == 6)
                    {
                        AssignedRequests.AddRange((from r in Model.SearchAllRequests(Type, SubType, asc, (int)RequestStatus.AssignedByAudit)


                                                   select r).ToList());
                        AssignedRequests.AddRange((from r in Model.SearchAllRequests(Type, SubType, asc, (int)RequestStatus.EndTechnicalApproveByAudit)


                                                   select r).ToList());

                        AssignedRequests.AddRange((from r in Model.SearchAllRequests(Type, SubType, asc, (int)RequestStatus.PendingTechnicalApproveByAudit)


                                                   select r).ToList());






                        return AssignedRequests;
                    }





                    return AssignedRequests;




                }
            }
            catch (Exception ex)
            {
                return null;
            }
        }
        public bool AssignRequestToMe(string UserName, string UserID, int RequestID)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    EmailApprovalRequest ReqToAssign = new EmailApprovalRequest();
                    ReqToAssign = (from r in Db.EmailApprovalRequests where r.ID == RequestID select r).SingleOrDefault();
                    var UserType = (from t in Db.CallCenterAppUsers where t.UserName == UserName select t.UserType).SingleOrDefault().ToString();
                    if (UserType == "CallCenterUser")
                    {
                        if (ReqToAssign.OperatorAssignee == null)
                        {

                            try
                            {
                                Db.Entry(ReqToAssign).Reload();
                                if (ReqToAssign.OperatorAssignee == null)
                                {
                                    ReqToAssign.RequstStatusID = (int)RequestStatus.AssignedByOpeartor;
                                    ReqToAssign.OperatorAssignee = UserName;
                                    ReqToAssign.OperatorAssignTime = DateTime.Now;
                                    Db.SaveChanges();
                                    return true;

                                }
                                else
                                {
                                    return false;
                                }
                            }
                            catch (Exception ex)
                            {

                                ExceptionHandlerConstants.CreateException(ex, "Helpers.cs", "AssignRequestToMe", "CallCenterSystemApp");
                                return false;
                            }



                        }

                        else
                        {
                            return false;
                        }
                    }
                    if (UserType == "CallCenterDoctor")
                    {
                        if (ReqToAssign.DoctorAssignee == null)
                        {


                            try
                            {

                                Db.Entry(ReqToAssign).Reload();
                                if (ReqToAssign.DoctorAssignee == null)
                                {
                                    ReqToAssign.RequstStatusID = (int)RequestStatus.AssignedByDoctor;
                                    ReqToAssign.DoctorAssignee = UserName;
                                    ReqToAssign.DoctorAssignTime = DateTime.Now;
                                    Db.SaveChanges();
                                    return true;


                                }

                                return false;
                            }
                            catch (Exception ex)
                            {
                                ExceptionHandlerConstants.CreateException(ex, "Helpers.cs", "AssignRequestToMe", "CallCenterSystemApp");
                                return false;
                            }


                        }
                        else
                        {
                            return false;
                        }

                    }
                    if (UserType == "CallCenterAuditDoctor")
                    {
                        if (ReqToAssign.AuditAssignee == null)
                        {


                            try
                            {

                                Db.Entry(ReqToAssign).Reload();
                                if (ReqToAssign.AuditAssignee == null)
                                {
                                    ReqToAssign.RequstStatusID = (int)RequestStatus.AssignedByAudit;

                                    ReqToAssign.AuditAssignee = UserName;
                                    ReqToAssign.AuditAssigneeTime = DateTime.Now;
                                    Db.SaveChanges();
                                    return true;


                                }

                                return false;

                            }

                            catch (Exception ex)
                            {

                                ExceptionHandlerConstants.CreateException(ex, "Helpers.cs", "AssignRequestToMe", "CallCenterSystemApp");
                                return false;
                            }





                        }
                    }
                    if (UserType == "CallCenterManager")
                    {
                        if (ReqToAssign.AuditAssignee == null)
                        {


                            try
                            {

                                Db.Entry(ReqToAssign).Reload();
                                if (ReqToAssign.AuditAssignee == null)
                                {
                                    ReqToAssign.RequstStatusID = (int)RequestStatus.AssignedByAudit;
                                    ReqToAssign.AuditAssignee = UserName;
                                    ReqToAssign.AuditAssigneeTime = DateTime.Now;

                                    Db.SaveChanges();
                                    return true;


                                }

                                return false;


                            }

                            catch (Exception ex)
                            {
                                ExceptionHandlerConstants.CreateException(ex, "Helpers.cs", "AssignRequestToMe", "CallCenterSystemApp");
                                return false;
                            }


                        }
                        else
                        {
                            return false;
                        }
                    }
                    else
                    {
                        return false;
                    }
                }
            }
            catch (Exception ex)
            {
                ExceptionHandlerConstants.CreateException(ex, "Helpers.cs", "AssignRequestToMe", "CallCenterSystemApp");
                return false;
            }

        }
        public bool ReleaseRequest(string UserName, string UserID, int RequestID)
        {
            using (PhNetworkEntities Db = new PhNetworkEntities())
            {
                EmailApprovalRequest ReqToAssign = new EmailApprovalRequest();
                ReqToAssign = (from r in Db.EmailApprovalRequests where r.ID == RequestID select r).SingleOrDefault();
                var UserType = (from t in Db.CallCenterAppUsers where t.UserName == UserName select t.UserType).SingleOrDefault().ToString();
                if (UserType == "CallCenterManager")
                {


                    try
                    {
                        if (ReqToAssign.RequstStatusID == (int)RequestStatus.PendingAuditAssign)
                        {
                            ReqToAssign.RequstStatusID = (int)RequestStatus.AssignedByAudit;
                        }
                        else if (ReqToAssign.RequstStatusID == (int)RequestStatus.PendingDoctorsAssign)

                        {
                            ReqToAssign.RequstStatusID = (int)RequestStatus.AssignedByDoctor;

                        }
                        Db.SaveChanges();
                        return true;
                    }

                    catch (Exception ex)
                    {
                        ExceptionHandlerConstants.CreateException(ex, "Helpers.cs", "ReleaseRequest", "CallCenterSystemApp");
                        return false;
                    }


                }
                return false;

            }
        }
        
        public bool AssignRequestToMGR(string UserName, string UserID, int RequestID, string AssignComment)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    EmailApprovalRequest ReqToAssign = new EmailApprovalRequest();
                    ReqToAssign = (from r in Db.EmailApprovalRequests where r.ID == RequestID select r).SingleOrDefault();
                    var UserType = (from t in Db.CallCenterAppUsers where t.UserName == UserName select t.UserType).SingleOrDefault().ToString();

                    if (UserType == "CallCenterManager")
                    {

                        if (ReqToAssign.AuditAssignee == null)
                        {

                            using (System.Data.Entity.DbContextTransaction dbTran = Db.Database.BeginTransaction())
                            {
                                try
                                {
                                    ReqToAssign.RequstStatusID = (int)RequestStatus.AssignedByAudit;
                                    ReqToAssign.AuditAssignee = UserName;
                                    ReqToAssign.AuditAssigneeTime = DateTime.Now;
                                    Db.SaveChanges();
                                    dbTran.Commit();

                                    return true;
                                }

                                catch (Exception ex)
                                {
                                    dbTran.Rollback();
                                    ExceptionHandlerConstants.CreateException(ex, "Helpers.cs", "AssignRequestToMGR", "CallCenterSystemApp");
                                    return false;
                                }
                            }

                        }
                        else
                        {

                            using (System.Data.Entity.DbContextTransaction dbTran = Db.Database.BeginTransaction())
                            {
                                ReqToAssign.RequstStatusID = (int)RequestStatus.AssignedByAudit;
                                ReqToAssign.AuditAssignee = null;
                                ReqToAssign.AuditAssignee = UserName;
                                ReqToAssign.AuditAssigneeTime = DateTime.Now;
                                Db.SaveChanges();
                                dbTran.Commit();
                                LogEmailApprovalEvent(ReqToAssign.ID, (int)EmailApprovalLogTypes.ManagerOverRideAuthentcation, Convert.ToInt32(UserID), UserName, "UnAssigned", UserName, "Forced Assign");

                                return true;
                            }
                        }
                    }
                    else
                    {
                        return false;
                    }
                }
            }
            catch (Exception ex)
            {
                ExceptionHandlerConstants.CreateException(ex, "Helpers.cs", "AssignRequestToMGR", "CallCenterSystemApp");
                return false;
            }

        }

        public bool TransfareRequestToBoolOrUser(int RequestID, int UserID, string TransfareComment, out string ValidationMessage, string UserToTransfare = null)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    var Request = Db.EmailApprovalRequests.Where(x => x.ID == RequestID).SingleOrDefault();

                    var User = GetUserByID(UserID);
                    string LogNewValue = null;
                    string LogOldValue = null;

                    if (User.UserType == "CallCenterDoctor")
                    {
                        LogOldValue = Request.DoctorAssignee;
                        if (UserToTransfare != null)
                        {
                            Request.RequstStatusID = (int)RequestStatus.AssignedByDoctor;
                            Request.DoctorAssignee = UserToTransfare;
                            LogNewValue = UserToTransfare;
                        }
                        else
                        {
                            Request.RequstStatusID = (int)RequestStatus.PendingDoctorsAssign;
                            Request.DoctorAssignee = null;
                            Request.DoctorAssignTime = null;
                            LogNewValue = "N/A";
                        }
                    }
                    //New-----------------------------------------------------------------NEW
                    if (User.UserType == "CallCenterManager" && Request.AuditAssignee != User.UserName)
                    {
                        if (Request.RequstStatusID == (int)RequestStatus.AssignedByDoctor)
                        {
                            if (UserToTransfare != null)
                            {
                                Request.RequstStatusID = (int)RequestStatus.AssignedByDoctor;
                                Request.DoctorAssignee = UserToTransfare;
                                LogNewValue = UserToTransfare;
                            }
                            else
                            {
                                Request.RequstStatusID = (int)RequestStatus.PendingDoctorsAssign;
                                Request.DoctorAssignee = null;
                                Request.DoctorAssignTime = null;
                                LogNewValue = "N/A";
                            }

                        }
                        else if (Request.RequstStatusID == (int)RequestStatus.AssignedByAudit)
                        {
                            if (UserToTransfare != null)
                            {
                                Request.RequstStatusID = (int)RequestStatus.AssignedByAudit;
                                Request.AuditAssignee = UserToTransfare;
                                LogNewValue = UserToTransfare;
                            }
                            else
                            {
                                Request.RequstStatusID = (int)RequestStatus.PendingAuditAssign;
                                Request.AuditAssignee = null;
                                Request.AuditAssigneeTime = null;
                                LogNewValue = "N/A";
                            }
                        }


                    }


                    if ((User.UserType == "CallCenterAuditDoctor") || (User.UserType == "CallCenterManager" && Request.AuditAssignee == User.UserName))
                    {
                        LogOldValue = Request.AuditAssignee;
                        if (UserToTransfare != null)
                        {
                            Request.RequstStatusID = (int)RequestStatus.AssignedByAudit;
                            Request.AuditAssignee = UserToTransfare;
                            LogNewValue = UserToTransfare;
                        }
                        else
                        {
                            Request.RequstStatusID = (int)RequestStatus.PendingAuditAssign;
                            Request.AuditAssignee = null;
                            Request.AuditAssigneeTime = null;
                            LogNewValue = "N/A";
                        }
                    }
                    bool Success = LogEmailApprovalEvent(RequestID, (int)EmailApprovalLogTypes.Transfer, UserID, User.UserName, LogOldValue, LogNewValue, TransfareComment);
                    if (Success == true)
                    {
                        Db.SaveChanges();
                        ValidationMessage = "Request Transferred Successfully";
                        return true;
                    }
                    else
                    {
                        ValidationMessage = "Somthing Went Wrong ,Please Try Again";
                        return false;
                    }
                }
            }
            catch (Exception ex)
            {
                ValidationMessage = "Somthing Went Wrong";
                return false;
                throw;
            }
        }

        public List<ModelViewTable> GetAllClosedRequestOrByUserName(string UserName, string Type, string SubType, int? asc)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    List<ModelViewTable> ClosedTickets = new List<ModelViewTable>();
                    var UserType = (from t in Db.CallCenterAppUsers where t.UserName == UserName select t.UserType).SingleOrDefault().ToString();
                    if (UserName == null)
                    {
                        ClosedTickets = (from r in Model.SearchAllRequests(Type, SubType, asc, (int)RequestStatus.Closed) select r).ToList();
                        return ClosedTickets;
                    }
                    if (UserName != null && UserType == "CallCenterUser")
                    {
                        int number = (int)RequestStatus.Closed;
                        ClosedTickets = (from r in Model.SearchAllRequests(Type, SubType, asc, number)
                                         where
                                          (r.OperatorAssignee == UserName || r.CreatedBy == UserName)
                                         select r).ToList();
                        return ClosedTickets;
                    }
                    if (UserName != null && UserType == "CallCenterDoctor")
                    {
                        ClosedTickets = (from r in Model.SearchAllRequests(Type, SubType, asc, (int)RequestStatus.Closed)
                                         where
                                          r.DoctorAssignee == UserName
                                         select r).ToList();
                        return ClosedTickets;

                    }
                    if (UserName != null && UserType == "CallCenterAuditDoctor")
                    {
                        ClosedTickets = (from r in Model.SearchAllRequests(Type, SubType, asc, (int)RequestStatus.Closed)
                                         where
                                          r.AuditAssignee == UserName
                                         select r).ToList();
                        return ClosedTickets;

                    }
                    if (UserName != null && (UserType == "CallCenterManager" || UserType == "DirectorUser"))
                    {
                        ClosedTickets = (from r in Model.SearchAllRequests(Type, SubType, asc, (int)RequestStatus.Closed)

                                             // && r.AuditAssignee == UserName
                                         select r).ToList();
                        return ClosedTickets;

                    }
                    else
                    {
                        return ClosedTickets;
                    }

                }
            }
            catch (Exception ex)
            {
                return null;
            }

        }
        public int GetAllClosedRequestOrByUserNameCount(string UserName)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    int ClosedTickets = 0;
                    var UserType = (from t in Db.CallCenterAppUsers where t.UserName == UserName select t.UserType).SingleOrDefault().ToString();
                    if (UserName == null)
                    {
                        ClosedTickets = (from r in Db.EmailApprovalRequests where r.RequstStatusID == (int)RequestStatus.Closed select r.ID).Count();
                        return ClosedTickets;
                    }
                    if (UserName != null && UserType == "CallCenterUser")
                    {
                        int number = (int)RequestStatus.Closed;
                        ClosedTickets = (from r in

                                        Db.EmailApprovalRequests
                                         where r.RequstStatusID == number &&
                                          (r.OperatorAssignee == UserName || r.CreatedBy == UserName)
                                         select r.ID).Count();
                        return ClosedTickets;
                    }
                    if (UserName != null && UserType == "CallCenterDoctor")
                    {
                        ClosedTickets = (from r in Db.EmailApprovalRequests
                                         where r.RequstStatusID == (int)RequestStatus.Closed
                                         &&
                                          r.DoctorAssignee == UserName
                                         select r.ID).Count();
                        return ClosedTickets;

                    }
                    if (UserName != null && UserType == "CallCenterAuditDoctor")
                    {
                        ClosedTickets = (from r in Db.EmailApprovalRequests
                                         where r.RequstStatusID == (int)RequestStatus.Closed
                                         &&
                                          r.AuditAssignee == UserName
                                         select r.ID).Count();
                        return ClosedTickets;

                    }
                    if (UserName != null && (UserType == "CallCenterManager" || UserType == "DirectorUser"))
                    {
                        ClosedTickets = (from r in Db.EmailApprovalRequests
                                         where r.RequstStatusID == (int)RequestStatus.Closed

                                         // && r.AuditAssignee == UserName
                                         select r.ID).Count();
                        return ClosedTickets;

                    }
                    else
                    {
                        return ClosedTickets;
                    }

                }
            }
            catch (Exception ex)
            {
                return 0;
            }

        }
        public bool TransfareRequestToAudit(int RequestID, string TransfareToAuditComment, string
            UserName, HttpPostedFile files, System.Web.UI.WebControls.FileUpload FileUpload1, string ServerMapPath,
            out string ValidationMessage)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {

                    EmailApprovalRequest ReqToTransfareToAudit = new EmailApprovalRequest();
                    ReqToTransfareToAudit = (from r in Db.EmailApprovalRequests where r.ID == RequestID select r).SingleOrDefault();
                    ReqToTransfareToAudit.TransferedToAuditComment = TransfareToAuditComment;
                    ReqToTransfareToAudit.TransferedToAuditTime = DateTime.Now;
                    ReqToTransfareToAudit.RequstStatusID = (int)RequestStatus.PendingAuditAssign;
                    ReqToTransfareToAudit.DoctorAction = "TransferToAudit";
                    ReqToTransfareToAudit.DoctorActionTime = DateTime.Now;


                    var UserType = (from t in Db.CallCenterAppUsers where t.UserName == UserName select t.UserType).SingleOrDefault().ToString();
                    bool IsUploaded = EmailRequestFileUpload(FileUpload1.PostedFile, RequestID, ServerMapPath, UserType, FileUpload1, false);
                    if (IsUploaded)
                    {
                        Db.SaveChanges();
                        ValidationMessage = "Your Request Is Transfered Successfully";
                        return true;
                    }
                    else
                    {
                        ValidationMessage = "File(s) Have Not Been Uploaded and Email Is Not Sent , Please Try a gain";
                        return false;

                    }
                }
            }
            catch (Exception ex)
            {
                ValidationMessage = "Error";
                return false;
            }

        }
        public void StartTechnicalApproveByUserType(string UserName, int RequestID, string TechnicalApproveNote)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    EmailApprovalRequest ReqToBeTechnicallyApproved = new EmailApprovalRequest();
                    ReqToBeTechnicallyApproved = (from r in Db.EmailApprovalRequests where r.ID == RequestID select r).SingleOrDefault();
                    var UserType = (from t in Db.CallCenterAppUsers where t.UserName == UserName select t.UserType).SingleOrDefault().ToString();
                    if (UserType == "CallCenterDoctor")
                    {
                        ReqToBeTechnicallyApproved.TechnicalApproveByDoctorStartTime = DateTime.Now;
                        ReqToBeTechnicallyApproved.TechnicalApproveByDoctorNote = TechnicalApproveNote;
                        ReqToBeTechnicallyApproved.RequstStatusID = (int)RequestStatus.PendingTechnicalApproveByDoctor;
                        Db.SaveChanges();
                    }
                    if (UserType == "CallCenterAuditDoctor" || UserType == "CallCenterManager")
                    {
                        ReqToBeTechnicallyApproved.TechnicalApproveByAuditStartTime = DateTime.Now;
                        ReqToBeTechnicallyApproved.TechnicalApproveByAuditNote = TechnicalApproveNote;
                        ReqToBeTechnicallyApproved.RequstStatusID = (int)RequestStatus.PendingTechnicalApproveByAudit;
                        Db.SaveChanges();
                    }
                }
            }
            catch (Exception ex)
            {

            }

        }
        public void TechnicalApproveWithOtherTeam(string UserName, int RequestID,List<int> ListOfDepartments, string TechnicalApproveNote)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    EmailApprovalRequest ReqToBeTechnicallyApproved = new EmailApprovalRequest();
                  List<  EmailRequestRequest_TechnicalDestination> listTechnicalApproveDestination = new List<EmailRequestRequest_TechnicalDestination>();

                    ReqToBeTechnicallyApproved = (from r in Db.EmailApprovalRequests where r.ID == RequestID select r).SingleOrDefault();
                    var UserType = (from t in Db.CallCenterAppUsers where t.UserName == UserName select t.UserType).SingleOrDefault().ToString();
                    if (UserType == "CallCenterDoctor")
                    {

                        foreach (var item in ListOfDepartments)
                        {
                            EmailRequestRequest_TechnicalDestination TechnicalApproveDestination = new EmailRequestRequest_TechnicalDestination();

                             TechnicalApproveDestination.StartTechnicalApprovalTime = DateTime.Now;
                            TechnicalApproveDestination.RequestID = RequestID;
                            TechnicalApproveDestination.TechnicalDestinationID = item;
                            TechnicalApproveDestination.CallCenterNote = TechnicalApproveNote;
                            listTechnicalApproveDestination.Add(TechnicalApproveDestination);
                        }
                        Db.EmailRequestRequest_TechnicalDestination.AddRange(listTechnicalApproveDestination);
                        ReqToBeTechnicallyApproved.UserNameOpenTechnicalApprove = UserName;
                        ReqToBeTechnicallyApproved.RequstStatusID = (int)RequestStatus.PendingTechnicalApproveFromDepartments;
                        Db.SaveChanges();
                    }
                    if (UserType == "CallCenterAuditDoctor" || UserType == "CallCenterManager")
                    {
                        foreach (var item in ListOfDepartments)
                        {
                            EmailRequestRequest_TechnicalDestination TechnicalApproveDestination = new EmailRequestRequest_TechnicalDestination();

                            TechnicalApproveDestination.StartTechnicalApprovalTime = DateTime.Now;
                            TechnicalApproveDestination.RequestID = RequestID;
                            TechnicalApproveDestination.TechnicalDestinationID = item;
                            TechnicalApproveDestination.CallCenterNote = TechnicalApproveNote;
                            listTechnicalApproveDestination.Add(TechnicalApproveDestination);
                        }
                        Db.EmailRequestRequest_TechnicalDestination.AddRange(listTechnicalApproveDestination);
                        ReqToBeTechnicallyApproved.UserNameOpenTechnicalApprove = UserName;
                        ReqToBeTechnicallyApproved.RequstStatusID = (int)RequestStatus.PendingTechnicalApproveFromDepartments;
                        Db.SaveChanges();
                    }
                }
            }
            catch (Exception ex)
            {

            }

        }
       


        public void EndTechnicalApproveByUserType(string UserName, int RequestID)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    EmailApprovalRequest ReqToBeTechnicallyApproved = new EmailApprovalRequest();
                    ReqToBeTechnicallyApproved = (from r in Db.EmailApprovalRequests where r.ID == RequestID select r).SingleOrDefault();
                    var UserType = (from t in Db.CallCenterAppUsers where t.UserName == UserName select t.UserType).SingleOrDefault().ToString();
                    if (UserType == "CallCenterDoctor")
                    {
                        ReqToBeTechnicallyApproved.TechnicalApproveByDoctorEndTime = DateTime.Now;
                        ReqToBeTechnicallyApproved.RequstStatusID = (int)RequestStatus.EndTechnicalApproveByDoctor;
                        Db.SaveChanges();
                    }
                    if (UserType == "CallCenterAuditDoctor" || UserType == "CallCenterManager")
                    {
                        ReqToBeTechnicallyApproved.TechnicalApproveByAuditEndTime = DateTime.Now;
                        ReqToBeTechnicallyApproved.RequstStatusID = (int)RequestStatus.EndTechnicalApproveByAudit;
                        Db.SaveChanges();
                    }
                }
            }
            catch (Exception ex)
            {
            }

        }
        public bool EmailRequestFileUpload(HttpPostedFile files, int RequestID, string ServerMapPath,
            string Usertype, System.Web.UI.WebControls.FileUpload FileUpload1, bool? IsInquiryFiles)
        {
            var Request = GetEmailApprovalRequestByID(RequestID);
            string FilePath = null;
            string SavePath = null;
            bool IsTicketAttach = false;
            bool IsDoctorAttach = false;
            bool IsAuditAttach = false;
            bool IsInquiryAttach = false;
            bool IsReopenAttach = false;
            bool ISFaxAttach = false;

            if (Usertype == "CallCenterUser" && Request.IsFaxMail == true)
            {
                FilePath = ServerMapPath + "EmailRequestAttach/" + RequestID + "/" + "FaxAttach";
                SavePath = "~/EmailRequestAttach/" + RequestID + "/" + "FaxAttach";
                ISFaxAttach = true;
            }
            if (Usertype == "CallCenterUser" && IsInquiryFiles == false)
            {
                FilePath = ServerMapPath + "EmailRequestAttach/" + RequestID + "/" + "TicketAttach";
                SavePath = "~/EmailRequestAttach/" + RequestID + "/" + "TicketAttach";
                IsTicketAttach = true;
            }
            if (Usertype == "CallCenterUser" && IsInquiryFiles == true)
            {
                FilePath = ServerMapPath + "EmailRequestAttach/" + RequestID + "/" + "InquiryAttach";
                SavePath = "~/EmailRequestAttach/" + RequestID + "/" + "InquiryAttach";
                IsInquiryAttach = true;
            }
            if (Usertype == "CallCenterDoctor")
            {
                if (Request.RequstStatusID == (int)RequestStatus.ReOpenedByDoctor)
                {

                    List<EmailRequestAttachmentsDetail> listOfAttachment = new List<EmailRequestAttachmentsDetail>();
                    using (PhNetworkEntities data = new PhNetworkEntities())

                    {
                        listOfAttachment = data.EmailRequestAttachmentsDetails.Where(x => x.TicketNumber == RequestID && x.IsReopeningAttachment == true).ToList();
                        foreach (var item in listOfAttachment)
                        {
                            if (item.IsReopeningAttachment == true)
                            {
                                item.IsReopeningAttachment = false;

                            }
                        }
                        data.SaveChanges();
                    }



                    FilePath = ServerMapPath + "EmailRequestAttach/" + RequestID + "/" + "DoctorAttach/ReopenAttach";
                    SavePath = "~/EmailRequestAttach/" + RequestID + "/" + "DoctorAttach/ReopenAttach";
                    IsDoctorAttach = true;
                    IsReopenAttach = true;
                }
                else
                {
                    FilePath = ServerMapPath + "EmailRequestAttach/" + RequestID + "/" + "DoctorAttach";
                    SavePath = "~/EmailRequestAttach/" + RequestID + "/" + "DoctorAttach";
                    IsDoctorAttach = true;

                }

            }
            if (Usertype == "CallCenterAuditDoctor" || Usertype == "CallCenterManager")
            {
                if (Request.RequstStatusID == (int)RequestStatus.ReOpenedByAudit)
                {

                    List<EmailRequestAttachmentsDetail> listOfAttachment = new List<EmailRequestAttachmentsDetail>();
                    using (PhNetworkEntities data = new PhNetworkEntities())

                    {
                        listOfAttachment = data.EmailRequestAttachmentsDetails.Where(x => x.TicketNumber == RequestID && x.IsReopeningAttachment == true).ToList();
                        foreach (var item in listOfAttachment)
                        {
                            if (item.IsReopeningAttachment == true)
                            {
                                item.IsReopeningAttachment = false;

                            }
                        }
                        data.SaveChanges();

                    }



                    FilePath = ServerMapPath + "EmailRequestAttach/" + RequestID + "/" + "AuditAttach/ReopenAttach";
                    SavePath = "~/EmailRequestAttach/" + RequestID + "/" + "AuditAttach/ReopenAttach";
                    IsReopenAttach = true;
                    IsAuditAttach = true;
                }
                else
                {
                    FilePath = ServerMapPath + "EmailRequestAttach/" + RequestID + "/" + "AuditAttach";
                    SavePath = "~/EmailRequestAttach/" + RequestID + "/" + "AuditAttach";
                    IsAuditAttach = true;
                }

            }
            try
            {
                foreach (HttpPostedFile postedFile in FileUpload1.PostedFiles)
                {

                    string fileName = Path.GetFileName(postedFile.FileName);

                    if (fileName != "")
                    {
                        if (!Directory.Exists(FilePath))
                        {
                            DirectoryInfo di = Directory.CreateDirectory(FilePath);
                        }


                        postedFile.SaveAs(FilePath + "/" + fileName);

                        using (PhNetworkEntities Db = new PhNetworkEntities())
                        {
                            EmailRequestAttachmentsDetail EmailRequestAttachDetails = new EmailRequestAttachmentsDetail();
                            EmailRequestAttachDetails.Name = fileName;
                            EmailRequestAttachDetails.Path = SavePath + "/" + fileName;
                            EmailRequestAttachDetails.IsTicketAttachment = IsTicketAttach;
                            EmailRequestAttachDetails.IsDoctorAttachment = IsDoctorAttach;
                            EmailRequestAttachDetails.IsAuditAttachment = IsAuditAttach;
                            EmailRequestAttachDetails.IsOtherAttachment = IsInquiryAttach;
                            EmailRequestAttachDetails.IsReopeningAttachment = IsReopenAttach;
                            EmailRequestAttachDetails.IsFaxAttachment = ISFaxAttach;
                            EmailRequestAttachDetails.TicketNumber = RequestID;
                            Db.EmailRequestAttachmentsDetails.Add(EmailRequestAttachDetails);
                            Db.SaveChanges();

                        }

                    }

                }
                return true;

            }
            catch (Exception ex)
            {
                return false;
            }
        }
        public List<EmailRequestAttachmentsDetail> GetAllAttachmentByRequestId(int RequesId)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    var RequestAttachments = (from r in Db.EmailRequestAttachmentsDetails where r.TicketNumber == RequesId select r).ToList();
                    return RequestAttachments;

                }
            }
            catch (Exception ex)
            {
                return null;
            }
        }
        public void CloseEmailRequest(int RequestID)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    var RequestToBeClosed = (from r in Db.EmailApprovalRequests where r.ID == RequestID select r).SingleOrDefault();
                    RequestToBeClosed.ClosedTime = DateTime.Now;
                    RequestToBeClosed.RequstStatusID = (int)RequestStatus.Closed;
                    Db.SaveChanges();
                }
            }
            catch (Exception ex)
            {
            }
        }
        public void SaveAsFaxEmail(int Id, string DoctorName, string ClientName, string MedicalID, string MemberName, string ProviderName, string TicketCategoryID, string PriorityID,string FaxTicketsType)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    var RequestSaved = (from r in Db.EmailApprovalRequests where r.ID == Id select r).SingleOrDefault();
                    var UserType = Db.CallCenterAppUsers.Where(p => p.UserName == DoctorName).FirstOrDefault().UserType;
                    RequestSaved.OperatorActionTime = DateTime.Now;
                    RequestSaved.OperatorAction = "SaveAsFax";
                    RequestSaved.ProviderName = ProviderName;
                    RequestSaved.PriorityID = Convert.ToInt32(PriorityID);
                    RequestSaved.TicketTypeID = Convert.ToInt32(FaxTicketsType);
                    RequestSaved.ApprovalCategoryID = Convert.ToInt32(TicketCategoryID);
                    if (UserType == "CallCenterDoctor")
                    {
                        RequestSaved.DoctorAssignee = DoctorName;
                        RequestSaved.DoctorAssignTime = DateTime.Now;
                    }
                    else
                    {
                        RequestSaved.AuditAssignee = DoctorName;
                        RequestSaved.AuditAssigneeTime = DateTime.Now;
                    }
                    RequestSaved.CompanyName = ClientName;
                    RequestSaved.Medical_ID = Convert.ToInt32(MedicalID);
                    RequestSaved.RequstStatusID = (int)RequestStatus.SavedAsFax;
                    RequestSaved.PatientName = MemberName;
                    Db.SaveChanges();

                }
            }
            catch (Exception ex)
            {
            }
        }
        public bool CreateBackup(HttpPostedFile files, int RequestID, string Usertype, System.Web.UI.WebControls.FileUpload FileUpload1, bool Inquiry)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    if (Db.EmailApprovalsConfigurations.Where(p => p.ConfigurationKey == "TakeBackup").FirstOrDefault().ConfigurationValue == "1")
                    {

                        var Request = GetEmailApprovalRequestByID(RequestID);
                        string FilePath = null;
                        string BackupPath = Db.EmailApprovalsConfigurations.Where(p => p.ConfigurationKey == "AttachmentsBackupPath").FirstOrDefault().ConfigurationValue;

                        if (Usertype == "CallCenterUser")
                        {
                            if (Request.IsFaxMail == true)
                            {
                                FilePath = BackupPath + "EmailRequestAttach/" + RequestID + "/" + "FaxAttach";
                            }
                            else if (Inquiry == true)
                            {
                                FilePath = BackupPath + "EmailRequestAttach/" + RequestID + "/" + "InquiryTicketAttach";
                            }

                            else if (Inquiry != true)
                            {
                                FilePath = BackupPath + "EmailRequestAttach/" + RequestID + "/" + "TicketAttach";
                            }

                        }

                        if (Usertype == "CallCenterDoctor")
                        {
                            if (Request.RequstStatusID == (int)RequestStatus.ReOpenedByDoctor)
                            {
                                FilePath = BackupPath + "EmailRequestAttach/" + RequestID + "/" + "DoctorAttach/ReopenAttach";
                            }
                            else
                            {
                                FilePath = BackupPath + "EmailRequestAttach/" + RequestID + "/" + "DoctorAttach";
                            }

                        }
                        if (Usertype == "CallCenterAuditDoctor" || Usertype == "CallCenterManager")
                        {
                            if (Request.RequstStatusID == (int)RequestStatus.ReOpenedByAudit)
                            {
                                FilePath = BackupPath + "EmailRequestAttach/" + RequestID + "/" + "AuditAttach/ReopenAttach";
                            }
                            else
                            {
                                FilePath = BackupPath + "EmailRequestAttach/" + RequestID + "/" + "AuditAttach";
                            }

                        }
                        foreach (HttpPostedFile postedFile in FileUpload1.PostedFiles)
                        {
                            string fileName = Path.GetFileName(postedFile.FileName);

                            if (fileName != "")
                            {
                                if (!Directory.Exists(FilePath))
                                {
                                    DirectoryInfo di = Directory.CreateDirectory(FilePath);
                                }
                                FileUpload1.SaveAs(FilePath + "/" + FileUpload1.FileName);
                            }
                        }
                        return true;

                    }
                    return true;

                }
            }
            catch (Exception ex)
            {
                return false;
            }
        }
        public void AddEmailRequestMailingDetailsByRequestID(int RequestID, List<string> ToRecipients, List<string> CcRecipients, List<string> BccRecipients)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    List<EmailRequestMailingDetail> MailDetails = new List<EmailRequestMailingDetail>();
                    foreach (var item in ToRecipients)
                    {
                        EmailRequestMailingDetail temp = new EmailRequestMailingDetail()
                        {
                            Email = item.ToString(),
                            IsTO = true,
                            IsBCC = false,
                            IsCC = false,
                            TicketNumber = RequestID,
                            IsDeleted = false

                        };
                        MailDetails.Add(temp);

                    }
                    foreach (var item in CcRecipients)
                    {
                        EmailRequestMailingDetail temp = new EmailRequestMailingDetail()
                        {
                            Email = item.ToString(),
                            IsTO = false,
                            IsCC = true,
                            IsBCC = false,
                            IsDeleted = false,
                            TicketNumber = RequestID,
                        };
                        MailDetails.Add(temp);

                    }
                    foreach (var item in BccRecipients)
                    {
                        EmailRequestMailingDetail temp = new EmailRequestMailingDetail()
                        {
                            Email = item.ToString(),
                            IsTO = false,
                            IsCC = false,
                            IsBCC = true,
                            IsDeleted = false,
                            TicketNumber = RequestID
                        };
                        MailDetails.Add(temp);
                    }
                    foreach (var item in MailDetails)
                    {
                        Db.EmailRequestMailingDetails.Add(item);
                    }
                    Db.SaveChanges();
                }
            }
            catch (Exception ex)
            {                ExceptionHandlerConstants.CreateCustomException("OpenCcEmailRequest", "SubmitNewCallcenterEmailApproval", ex);

            }
        }
        public IEnumerable<EmailRequestMailingDetail> GetAllMailingDetailsByRequestID(int RequestID)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    var FinalResult = Db.EmailRequestMailingDetails.Where(p => p.TicketNumber == RequestID && p.IsDeleted == false).ToList();
                    return FinalResult;
                }
            }
            catch (Exception ex)
            {
                return null;
            }


        }
        public List<string> UpdateEmails(int Request, List<string> ListOfPersons, string UserName, List<EmailRequestMailingDetail> ALLEmails)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    var Newresult = ListOfPersons.Where(p => !ALLEmails.Any(p2 => p2.Email == p));
                    var Deletedresult = ALLEmails.Where(p => !ListOfPersons.Any(p2 => p2 == p.Email));
                    List<string> newEmails = Newresult.Select(x => x).ToList();
                    foreach (var item in Deletedresult)

                    {
                        Db.EmailRequestMailingDetails.Where(x => x.TicketNumber == Request && x.Email == item.Email).SingleOrDefault().IsDeleted = true;

                        Db.EmailRequestMailingDetails.Where(x => x.TicketNumber == Request && x.Email == item.Email).SingleOrDefault().DeletedBy = UserName;
                        Db.EmailRequestMailingDetails.Where(x => x.TicketNumber == Request && x.Email == item.Email).SingleOrDefault().DeletionTime = DateTime.Now;

                    }


                    Db.SaveChanges();
                    return newEmails;
                }
            }
            catch (Exception ex)
            {
                return null;
            }
        }
        public bool ApproveRequestByUserType(int RequestID, string Notes, string UserName, HttpPostedFile files, System.Web.UI.WebControls.FileUpload FileUpload1, string ServerMapPath, out string ValidationMessage)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    EmailApprovalRequest ReqToApprove = new EmailApprovalRequest();
                    ReqToApprove = (from r in Db.EmailApprovalRequests where r.ID == RequestID select r).SingleOrDefault();
                    var User = (from t in Db.CallCenterAppUsers where t.UserName == UserName select t).SingleOrDefault();
                    if (User.UserType == "CallCenterDoctor")
                    {
                        if (ReqToApprove.RequstStatusID == (int)RequestStatus.ReOpenedByDoctor)
                        {
                            if (ReqToApprove.DoctorNotes != Notes)
                            {
                                var UpdateNotes = LogEmailApprovalEvent(ReqToApprove.ID, (int)EmailApprovalLogTypes.UpdateApproveOrRejectNotes, User.UserID, UserName, ReqToApprove.DoctorNotes, Notes);
                            }
                            var UpdateActionTime = LogEmailApprovalEvent(ReqToApprove.ID, (int)EmailApprovalLogTypes.UpdateActionTime, User.UserID, UserName, ReqToApprove.DoctorActionTime.ToString(), DateTime.Now.ToString());

                        }
                        ReqToApprove.DoctorNotes = Notes;
                        ReqToApprove.DoctorActionTime = DateTime.Now;
                        ReqToApprove.DoctorAction = "Approved";

                        bool IsUploaded = EmailRequestFileUpload(FileUpload1.PostedFile, RequestID, ServerMapPath, User.UserType, FileUpload1, false);

                        if (IsUploaded)
                        {

                            var EmailingResult = SendEmail.SendApprovalEmail(RequestID, ServerMapPath, Notes);

                            if (EmailingResult)
                            {
                                ReqToApprove.RequstStatusID = (int)RequestStatus.ApprovedByDoctor;
                                Db.SaveChanges();
                                ValidationMessage = "Your Request Is Approved Successfully";
                                return true;
                            }
                            else
                            {
                                ValidationMessage = "Email Has Not Been Sent , Please Try a gain";
                                return false;
                            }
                        }
                        else
                        {
                            ValidationMessage = "File(s) Have Not Been Uploaded and Email Is Not Sent , Please Try a gain";
                            return false;

                        }
                    }
                    else if (User.UserType == "CallCenterAuditDoctor" || User.UserType == "CallCenterManager")
                    {
                        if (ReqToApprove.RequstStatusID == (int)RequestStatus.ReOpenedByAudit)
                        {
                            if (ReqToApprove.DoctorNotes != Notes)
                            {
                                var UpdateNotes = LogEmailApprovalEvent(ReqToApprove.ID, (int)EmailApprovalLogTypes.UpdateApproveOrRejectNotes, User.UserID, UserName, ReqToApprove.AuditNotes, Notes);
                            }
                            var UpdateActionTime = LogEmailApprovalEvent(ReqToApprove.ID, (int)EmailApprovalLogTypes.UpdateActionTime, User.UserID, UserName, ReqToApprove.AuditActionTime.ToString(), DateTime.Now.ToString());

                        }
                        ReqToApprove.AuditNotes = Notes;
                        ReqToApprove.AuditActionTime = DateTime.Now;
                        ReqToApprove.AuditAction = "Approved";
                        bool IsUploaded = EmailRequestFileUpload(FileUpload1.PostedFile, RequestID, ServerMapPath, User.UserType, FileUpload1, false);

                        if (IsUploaded == true)
                        {
                            var EmailingResult = SendEmail.SendApprovalEmail(RequestID, ServerMapPath, Notes);
                            if (EmailingResult)
                            {
                                ReqToApprove.RequstStatusID = (int)RequestStatus.ApprovedByAudit;
                                Db.SaveChanges();
                                ValidationMessage = "Your Request Is Approved Successfully";
                                return true;
                            }
                            else
                            {
                                ValidationMessage = "Email Has Not Been Sent , Please Try a gain";
                                return false;
                            }
                        }
                        else
                        {
                            ValidationMessage = "File(s) Have Not Been Uploaded and Email Is Not Sent , Please Try a gain";
                            return false;

                        }
                    }
                    else
                    {
                        ValidationMessage = "File(s) Have Not Been Uploaded and Email Is Not Sent , Please Try a gain";
                        return false;
                    }
                }
            }
            catch (Exception ex)
            {
                ValidationMessage = "Error";
                return false;
            }
        }
        public bool RejectRequestByUserType(int RequestID, string Notes, string UserName, HttpPostedFile files, System.Web.UI.WebControls.FileUpload FileUpload1, string ServerMapPath, out string ValidationMessage)
        {

            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    EmailApprovalRequest ReqToApprove = new EmailApprovalRequest();
                    ReqToApprove = (from r in Db.EmailApprovalRequests where r.ID == RequestID select r).SingleOrDefault();
                    var User = (from t in Db.CallCenterAppUsers where t.UserName == UserName select t).SingleOrDefault();
                    if (User.UserType == "CallCenterDoctor")
                    {
                        if (ReqToApprove.RequstStatusID == (int)RequestStatus.ReOpenedByDoctor)
                        {
                            if (ReqToApprove.DoctorNotes != Notes)
                            {
                                var UpdateNotes = LogEmailApprovalEvent(ReqToApprove.ID, (int)EmailApprovalLogTypes.UpdateApproveOrRejectNotes, User.UserID, UserName, ReqToApprove.DoctorNotes, Notes);
                            }
                            var UpdateActionTime = LogEmailApprovalEvent(ReqToApprove.ID, (int)EmailApprovalLogTypes.UpdateActionTime, User.UserID, UserName, ReqToApprove.DoctorActionTime.ToString(), DateTime.Now.ToString());

                        }
                        ReqToApprove.DoctorNotes = Notes;
                        ReqToApprove.DoctorActionTime = DateTime.Now;
                        ReqToApprove.DoctorAction = "Rejected";

                        bool IsUploaded = EmailRequestFileUpload(FileUpload1.PostedFile, RequestID, ServerMapPath, User.UserType, FileUpload1, false);

                        if (IsUploaded)
                        {

                            var EmailingResult = SendEmail.SendRejectionEmail(RequestID, ServerMapPath, Notes);

                            if (EmailingResult)
                            {
                                ReqToApprove.RequstStatusID = (int)RequestStatus.RejectedByDoctor;
                                Db.SaveChanges();
                                ValidationMessage = "Your Request Is Approved Successfully";
                                return true;
                            }
                            else
                            {
                                ValidationMessage = "Email Has Not Been Sent , Please Try a gain";
                                return false;
                            }
                        }
                        else
                        {
                            ValidationMessage = "File(s) Have Not Been Uploaded and Email Is Not Sent , Please Try a gain";
                            return false;

                        }
                    }
                    else if (User.UserType == "CallCenterAuditDoctor" || User.UserType == "CallCenterManager")
                    {
                        if (ReqToApprove.RequstStatusID == (int)RequestStatus.ReOpenedByAudit)
                        {
                            if (ReqToApprove.DoctorNotes != Notes)
                            {
                                var UpdateNotes = LogEmailApprovalEvent(ReqToApprove.ID, (int)EmailApprovalLogTypes.UpdateApproveOrRejectNotes, User.UserID, UserName, ReqToApprove.AuditNotes, Notes);
                            }
                            var UpdateActionTime = LogEmailApprovalEvent(ReqToApprove.ID, (int)EmailApprovalLogTypes.UpdateActionTime, User.UserID, UserName, ReqToApprove.AuditActionTime.ToString(), DateTime.Now.ToString());

                        }
                        ReqToApprove.AuditNotes = Notes;
                        ReqToApprove.AuditActionTime = DateTime.Now;
                        ReqToApprove.AuditAction = "Rejected";
                        bool IsUploaded = EmailRequestFileUpload(FileUpload1.PostedFile, RequestID, ServerMapPath, User.UserType, FileUpload1, false);

                        if (IsUploaded == true)
                        {
                            var EmailingResult = SendEmail.SendRejectionEmail(RequestID, ServerMapPath, Notes);
                            if (EmailingResult)
                            {
                                ReqToApprove.RequstStatusID = (int)RequestStatus.RejectedByAudit;
                                Db.SaveChanges();
                                ValidationMessage = "Your Request Is Approved Successfully";
                                return true;
                            }
                            else
                            {
                                ValidationMessage = "Email Has Not Been Sent , Please Try a gain";
                                return false;
                            }
                        }
                        else
                        {
                            ValidationMessage = "File(s) Have Not Been Uploaded and Email Is Not Sent , Please Try a gain";
                            return false;

                        }
                    }
                    else
                    {
                        ValidationMessage = "File(s) Have Not Been Uploaded and Email Is Not Sent , Please Try a gain";
                        return false;
                    }

                }
            }
            catch (Exception ex)
            {
                ValidationMessage = "Error";
                return false;
            }

        }
        public List<CallCenterAppUser> GetAllUsers(string UserName)
        {
            using (PhNetworkEntities Db = new PhNetworkEntities())
            {
                var AllUsers = (from u in Db.CallCenterAppUsers where u.UserType == "CallCenterDoctor" || u.UserType == "CallCenterAuditDoctor" || u.UserType == "CallCenterManager" where u.UserName != UserName select u).ToList();
                return AllUsers;

            }
        }
        public CallCenterAppUser GetUserByID(int UserID)
        {
            using (PhNetworkEntities Db = new PhNetworkEntities())
            {
                var User = (from u in Db.CallCenterAppUsers where u.UserID == UserID select u).SingleOrDefault();
                return User;
            }
        }
        public bool ChangeUserTypeByUserID(int UserID, string UserType, out string ValidationMessage)
        {
            using (PhNetworkEntities Db = new PhNetworkEntities())
            {
                var User = (from u in Db.CallCenterAppUsers where u.UserID == UserID select u).SingleOrDefault();
                int PendingTickets = 0;


                if (User.UserType == UserType)
                {
                    ValidationMessage = "You Have Chosen The Same User Type For This User , Please Select Different User Type";
                    return false;
                }
                if (User.UserType != UserType)
                {

                    PendingTickets = (from r in Db.EmailApprovalRequests
                                      where r.DoctorAssignee == User.UserName || r.DoctorAssignee == User.UserName
                                      where
r.RequstStatusID != (int)RequestStatus.Closed
&&
r.RequstStatusID != (int)RequestStatus.Ignored

                                      select r.ID).Count();



                    if (PendingTickets > 0)
                    {
                        ValidationMessage = "You Can't Change This User Type , Because He/She Has " + PendingTickets + " Request(s) Pending";
                        return false;
                    }
                    if (PendingTickets == 0)
                    {
                        User.UserType = UserType;
                        Db.SaveChanges();
                        ValidationMessage = "The User Type Is Changed to " + UserType + " Successfully";
                        return true;
                    }
                    else
                    {
                        ValidationMessage = "Something Went Wrong , Please Try Again Later";

                        return false;
                    }
                }
                else
                {
                    ValidationMessage = "Something Went Wrong , Please Try Again Later";
                    return false;
                }

            }

        }
        public bool IgnoreAndCloseEmailRequestUserName(int RquestID, string UserName, out string ValidationMessage)
        {

            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    var UserType = Db.CallCenterAppUsers.Where(x => x.UserName == UserName).FirstOrDefault().UserType;
                    ValidationMessage = "";

                    if (UserType == "CallCenterDoctor")
                    {


                        var RequestToIgnoreAndClose = (from r in Db.EmailApprovalRequests where r.ID == RquestID select r).SingleOrDefault();
                        RequestToIgnoreAndClose.DoctorAction = "IgnoredByDoctor";
                        RequestToIgnoreAndClose.DoctorActionTime = DateTime.Now;
                        RequestToIgnoreAndClose.RequstStatusID = (int)RequestStatus.Ignored;
                        RequestToIgnoreAndClose.ClosedTime = DateTime.Now;
                        Db.SaveChanges();
                        ValidationMessage = "Ticket Ignored Successfully";
                        return true;
                    }
                    else if (UserType == "CallCenterAuditDoctor" || UserType == "CallCenterManager")

                    {
                        var RequestToIgnoreAndClose = (from r in Db.EmailApprovalRequests where r.ID == RquestID select r).SingleOrDefault();
                        RequestToIgnoreAndClose.AuditAction = "IgnoredByAudit";
                        RequestToIgnoreAndClose.AuditActionTime = DateTime.Now;
                        RequestToIgnoreAndClose.RequstStatusID = (int)RequestStatus.Ignored;
                        RequestToIgnoreAndClose.ClosedTime = DateTime.Now;
                        Db.SaveChanges();
                        ValidationMessage = "Ticket Ignored Successfully";
                        return true;
                    }
                    else if (UserType == "CallCenterUser")

                    {

                        var RequestToIgnoreAndClose = (from r in Db.EmailApprovalRequests where r.ID == RquestID select r).SingleOrDefault();
                        RequestToIgnoreAndClose.OperatorAction = "IgnoredByOperator";
                        RequestToIgnoreAndClose.OperatorActionTime = DateTime.Now;
                        RequestToIgnoreAndClose.RequstStatusID = (int)RequestStatus.Ignored;
                        RequestToIgnoreAndClose.ClosedTime = DateTime.Now;
                        Db.SaveChanges();
                        ValidationMessage = "Ticket Ignored Successfully";
                        return true;
                    }

                    else
                    {
                        return false;
                    }
                }
            }
            catch (Exception)
            {
                ValidationMessage = "Somthing Went Wrong , Please Try Again";
                return false;
            }

        }
        public bool OpenIsAutoGeneratedRequest(int Id, string UserName, HttpPostedFile files,
            System.Web.UI.WebControls.FileUpload FileUpload1, string ProviderName,
            string CallcenterOpenNote, int TicketType,
             string TicketCategoryID, string PriorityID,
            string ServerMapPath,
           string MemberName, string ClientName, int MedicalID
            , out string ValidationMessage)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    EmailApprovalRequest EmailRequest = new EmailApprovalRequest();
                    EmailRequest = Db.EmailApprovalRequests.Where(x => x.ID == Id).FirstOrDefault();
                    EmailRequest.ProviderName = ProviderName;
                    EmailRequest.CreatedByNotes = CallcenterOpenNote;
                    EmailRequest.TicketTypeID = TicketType;
                    EmailRequest.OperatorActionTime = DateTime.Now;
                    string UserType = "CallCenterUser";
                    EmailRequest.Medical_ID = MedicalID;
                    EmailRequest.PatientName = MemberName;
                    EmailRequest.CompanyName = ClientName;
                    EmailRequest.TransferedToDoctorsTime = DateTime.Now;
                    EmailRequest.RequstStatusID = (int)RequestStatus.PendingDoctorsAssign;
                    EmailRequest.ColorID = null;

                    EmailRequest.PriorityID = Convert.ToInt32(PriorityID);
                    EmailRequest.ApprovalCategoryID = Convert.ToInt32(TicketCategoryID);

                    EmailRequest.OperatorAction = "OpenNewTicket";
                    if (FileUpload1.HasFiles)
                    {
                        bool IsUploaded = EmailRequestFileUpload(FileUpload1.PostedFile, EmailRequest.ID, ServerMapPath, UserType, FileUpload1, false);
                        if (IsUploaded == true)
                        {
                            Db.SaveChanges();
                            ValidationMessage = "Ticket Opened Successfully";
                            return true;
                        }
                        else
                        {
                            ValidationMessage = "Error In Uploading Files ,Please Check Files And Try Again";
                            return false;
                        }
                    }
                    else
                    {
                        Db.SaveChanges();
                        ValidationMessage = "Ticket Opened Successfully";
                        return true;
                    }
                }

            }
            catch (Exception ex)
            {
                ValidationMessage = "Somthing Went Wrong ,Please Try Again";
                return false;
            }

        }
        public bool ReplyOnInquiryByOperator(int RequestID, string OperatorNote,
            int MemberTypeFlag, string UserName,
            HttpPostedFile files, System.Web.UI.WebControls.FileUpload FileUpload1,
            string ServerMapPath, out string ValidationMessage)
        {


            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    Mailing Mailing = new Mailing();
                    string UserType = "CallCenterUser";

                    var ReplyOnInquiryRequest = Db.EmailApprovalRequests.Where(p => p.ID == RequestID).FirstOrDefault();
                    ReplyOnInquiryRequest.OperatorNotes = OperatorNote;
                    ReplyOnInquiryRequest.TicketTypeID = (int)TicketTypes.Inquiries;
                    ReplyOnInquiryRequest.OperatorAction = "RepliedOnInquiry";
                    ReplyOnInquiryRequest.OperatorActionTime = DateTime.Now;
                    ReplyOnInquiryRequest.IsInquiryTicket = true;
                    ReplyOnInquiryRequest.RequstStatusID = (int)RequestStatus.RepliedOnInquiry;
                    if (FileUpload1.HasFiles)
                    {
                        bool IsUploaded = EmailRequestFileUpload(FileUpload1.PostedFile, ReplyOnInquiryRequest.ID, ServerMapPath, UserType, FileUpload1, true);
                        if (IsUploaded == true)
                        {
                            var IsMailSent = Mailing.SendIquiryReplyMail(ReplyOnInquiryRequest.ID, ServerMapPath, ReplyOnInquiryRequest.OperatorNotes, MemberTypeFlag);
                            if (IsMailSent == true)
                            {
                                Db.SaveChanges();
                                ValidationMessage = "Reply Sent Successfully";
                                return true;
                            }
                            else
                            {
                                ValidationMessage = "Reply Mail Not Sent ,Please try Again";
                                return false;
                            }

                        }
                        else
                        {
                            ValidationMessage = "Error In Uploading Files ,Please Check Files And Try Again";
                            return false;
                        }
                    }
                    else
                    {
                        var IsMailSent = Mailing.SendIquiryReplyMail(ReplyOnInquiryRequest.ID, ServerMapPath, ReplyOnInquiryRequest.OperatorNotes, MemberTypeFlag);

                        if (IsMailSent == true)
                        {
                            Db.SaveChanges();
                            ValidationMessage = "Reply Sent Successfully";
                            return true;
                        }
                        else
                        {
                            ValidationMessage = "Reply Mail Not Sent ,Please try Again";
                            return false;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                ValidationMessage = "Error";
                return false;
            }


        }
        public bool LogEmailApprovalEvent(int? RequestID, int LogTypeID, int UserID, string UserName, string OldValue, string NewValue, string LogComment = null)
        {

            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    EmailApprovalLogsDetail LogObj = new EmailApprovalLogsDetail();

                    LogObj.RequestID = RequestID;
                    LogObj.LogTypeID = LogTypeID;
                    LogObj.UserID = UserID;
                    LogObj.UserName = UserName;
                    LogObj.OldValue = OldValue;
                    LogObj.NewValue = NewValue;
                    LogObj.LogTime = DateTime.Now;
                    LogObj.Comment = LogComment;
                    Db.EmailApprovalLogsDetails.Add(LogObj);
                    Db.SaveChanges();
                    return true;
                }
            }
            catch (Exception ex)
            {
                return false;
            }
        }




        public bool ReOpenEmailApprovalRequest(int RequestID, int UserID, string ReOpenComment, out string ValidationMessage)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    var Request = Db.EmailApprovalRequests.Where(x => x.ID == RequestID).FirstOrDefault();
                    var User = GetUserByID(UserID);
                    string LogNewValue = null;
                    var LogOldValue = (RequestStatus)Enum.Parse(typeof(RequestStatus), Request.RequstStatusID.ToString())


                        ;
                    string UserOldName = "";
                    try
                    {
                        if (User.UserType == "CallCenterDoctor")
                        {
                            Request.RequstStatusID = (int)RequestStatus.ReOpenedByDoctor;
                            UserOldName = Request.DoctorAssignee;
                            Request.DoctorAssignee = User.UserName;
                            LogNewValue = RequestStatus.ReOpenedByDoctor.ToString();
                        }
                        if (User.UserType == "CallCenterAuditDoctor" || User.UserType == "CallCenterManager")
                        {
                            Request.RequstStatusID = (int)RequestStatus.ReOpenedByAudit;
                            Request.AuditAssignee = User.UserName;
                            UserOldName = Request.AuditAssignee;

                            LogNewValue = RequestStatus.ReOpenedByAudit.ToString();
                        }

                        var Success = LogEmailApprovalEvent(
                            RequestID,
                            (int)EmailApprovalLogTypes.ReopenTicket,
                            UserID,
                            User.UserName,
                            LogOldValue + "-" + UserOldName,
                            LogNewValue + "-" + User.UserName,
                            ReOpenComment);
                        if (Success == true)
                        {
                            Db.SaveChanges();
                            ValidationMessage = "Request ReOpened Successfully";
                            return true;
                        }
                        else
                        {
                            ValidationMessage = "Somthing Went Wrong ,Please Try Again";
                            return false;
                        }
                    }
                    catch (Exception ex)
                    {
                        ValidationMessage = "Somthing Went Wrong ,Please Try Again";
                        return false;
                        throw;
                    }
                }
            }
            catch (Exception ex)
            {
                ValidationMessage = "Error";
                return false;
            }
        }
        public void UpdateUserActivationData(string UserName)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {

                    var userData = Db.CallCenterAppUsers.Where(x => x.UserName == UserName).FirstOrDefault();
                    userData.MACAddress = ""/* GetPCName().ToString()*/;
                    userData.IsActive = true;
                    Db.SaveChanges();
                }
            }
            catch (Exception ex)
            {
            }

        }
        public static void DeleteUserActivationData(string UserName)
        {

            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    var userData = Db.CallCenterAppUsers.Where(x => x.UserName == UserName).FirstOrDefault();
                    userData.MACAddress = string.Empty;
                    userData.IsActive = false;
                    Db.SaveChanges();

                }
            }
            catch (Exception ex)
            {
            }
        }
        //public static string GetPCName()
        //{
        //    return null;
        //}
        public EmailApprovalRequest GetEmailApprovalRequestByID(int RequestID)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    var Request = (from r in Db.EmailApprovalRequests where r.ID == RequestID select r).SingleOrDefault();
                    return Request;

                }
            }
            catch (Exception ex)
            {
                return null;
            }
        }
        public bool ChangeEmailRequestMedicalID(int RequestID, int UserID, int NewValue, out string ValidationMessage)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    var Request = Db.EmailApprovalRequests.Where(x => x.ID == RequestID).SingleOrDefault();
                    var User = GetUserByID(UserID);
                    var Oldvalue = Request.Medical_ID;

                    if (Oldvalue == NewValue)
                    {
                        ValidationMessage = "you have entered the same Medical ID";
                        return false;
                    }
                    else
                    {
                        var Succsses = LogEmailApprovalEvent(RequestID, (int)EmailApprovalLogTypes.ChangeMedicalID, UserID, User.UserName, Oldvalue.ToString(), NewValue.ToString());
                        if (Succsses)
                        {
                            Request.Medical_ID = NewValue;
                            Db.SaveChanges();
                            ValidationMessage = "Medical ID changed successfully";
                            return true;
                        }
                        else
                        {
                            ValidationMessage = "Something went wrong ,please try again later";
                            return false;
                        }
                    }
                }
            }
            catch (Exception)
            {
                ValidationMessage = "Error";
                return false;
            }
        }

        public bool ChangeEmailRequestApprovalCategory(int RequestID, int UserID, string NewValue, out string ValidationMessage)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    var Request = Db.EmailApprovalRequests.Where(x => x.ID == RequestID).SingleOrDefault();
                    var User = GetUserByID(UserID);
                    var Oldvalue = Request.ApprovalCategoryID;


                    if (Oldvalue == Convert.ToInt32(NewValue))
                    {
                        ValidationMessage = "you have entered the same Approval Category";
                        return false;
                    }
                    else
                    {
                        var Succsses = LogEmailApprovalEvent(RequestID, (int)EmailApprovalLogTypes.ChangeMedicalID, UserID, User.UserName, Oldvalue.ToString(), NewValue.ToString());
                        if (Succsses)
                        {
                            Request.ApprovalCategoryID = Convert.ToInt32(NewValue);
                            Db.SaveChanges();
                            ValidationMessage = "Approval Category changed successfully";
                            return true;
                        }
                        else
                        {
                            ValidationMessage = "Something went wrong ,please try again later";
                            return false;
                        }
                    }
                }
            }
            catch (Exception)
            {
                ValidationMessage = "Error";
                return false;
            }
        }


        public bool ChangeEmailRequestType(int RequestID, int UserID, string NewValue, out string ValidationMessage)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    var Request = Db.EmailApprovalRequests.Where(x => x.ID == RequestID).SingleOrDefault();
                    var User = GetUserByID(UserID);
                    var Oldvalue = Request.TicketTypeID;

                    if (Oldvalue == Convert.ToInt32(NewValue))
                    {
                        ValidationMessage = "you have entered the same Request Type";
                        return false;
                    }
                    else
                    {
                        var Succsses = LogEmailApprovalEvent(RequestID, (int)EmailApprovalLogTypes.EditTicketType, UserID, User.UserName, Oldvalue.ToString(), NewValue.ToString());
                        if (Succsses)
                        {
                            Request.TicketTypeID = Convert.ToInt32(NewValue);
                            Db.SaveChanges();
                            ValidationMessage = "Request Type changed successfully";
                            return true;
                        }
                        else
                        {
                            ValidationMessage = "Something went wrong ,please try again later";
                            return false;
                        }
                    }
                }
            }
            catch (Exception)
            {
                ValidationMessage = "Error";
                return false;
            }
        }


        public List<CallCenterAppUser> GetActiveUsersByType(string UserType)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    var ActiveUsers = (from u in Db.CallCenterAppUsers where u.UserType == UserType && u.IsActive == true select u).ToList();
                    return ActiveUsers;
                }
            }
            catch (Exception ex)
            {
                return null;
            }
        }
        public List<CallCenterAppUser> GetAllActiveDoctorsAndAuditUsers()
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    var ActiveUsers = (from u in Db.CallCenterAppUsers where (u.UserType == "CallCenterDoctor" || u.UserType == "CallCenterManager" || u.UserType == "CallCenterAuditDoctor") && u.IsActive == true select u).ToList();
                    return ActiveUsers;
                }
            }
            catch (Exception ex)
            {
                return null;
            }
        }
        public List<CallCenterAppUser> GetAllDoctorsAndAudite()
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    var ActiveUsers = (from u in Db.CallCenterAppUsers where (u.UserType == "CallCenterDoctor" || u.UserType == "CallCenterManager" || u.UserType == "CallCenterAuditDoctor") select u).ToList();
                    return ActiveUsers;
                }
            }
            catch (Exception ex)
            {
                return null;
            }
        }
        public bool SubmitFaxRequest(int RequestID, int MedicalID, HttpPostedFile files,
            System.Web.UI.WebControls.FileUpload FileUpload1, string ProviderName,
             int ApprovalCategoryID, int PriorityID, string ServerMapPath,
           string MemberName, string ClientName, int DoctorOrAuditAssignID, out string ValidationMessage)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    var Request = GetEmailApprovalRequestByID(RequestID);
                    var DoctorOrAuditAssignUser = GetUserByID(DoctorOrAuditAssignID);

                    Request.Medical_ID = MedicalID;
                    Request.ProviderName = ProviderName;
                    Request.ApprovalCategoryID = ApprovalCategoryID;
                    Request.PriorityID = PriorityID;
                    Request.PatientName = MemberName;
                    Request.CompanyName = ClientName;
                    Request.RequstStatusID = (int)RequestStatus.Closed;

                    if (DoctorOrAuditAssignUser.UserType == "CallCenterDoctor")
                    {
                        Request.DoctorAssignee = DoctorOrAuditAssignUser.UserName;
                        Request.DoctorAssignTime = DateTime.Now;
                        Request.DoctorAction = "FaxRequest";
                        Request.DoctorActionTime = DateTime.Now;
                    }
                    else if (DoctorOrAuditAssignUser.UserType == "CallCenterAuditDoctor" || DoctorOrAuditAssignUser.UserType == "CallCenterManager")
                    {
                        Request.AuditAssignee = DoctorOrAuditAssignUser.UserName;
                        Request.AuditAssigneeTime = DateTime.Now;
                        Request.AuditAction = "FaxRequest";
                        Request.AuditActionTime = DateTime.Now;
                    }

                    var SuccessUpload = EmailRequestFileUpload(FileUpload1.PostedFile, RequestID, ServerMapPath, DoctorOrAuditAssignUser.UserType, FileUpload1, false);
                    if (SuccessUpload)
                    {
                        Db.SaveChanges();
                        ValidationMessage = "Fax Request submitted successfully";
                        return true;
                    }
                    else
                    {
                        ValidationMessage = "Fax Request is not submitted ,please try again";
                        return false;
                    }
                }
            }
            catch (Exception ex)
            {
                ValidationMessage = "Somthing went wrong ,please try again";
                return false;
                throw;
            }

        }
        public List<ModelViewTable> GetIgnoredRequestsByUserName(string UserName, string Type, string SubType, int? asc)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    var user = (from u in Db.CallCenterAppUsers where u.UserName == UserName select u).SingleOrDefault();
                    List<ModelViewTable> Requests = new List<ModelViewTable>();
                    if (user.UserType == "CallCenterUser")
                    {
                        Requests = (from r in Model.SearchAllRequests(Type, SubType, asc, (int)RequestStatus.Ignored) where r.OperatorAssignee == UserName select r).ToList();
                        return Requests;
                    }
                    else if (user.UserType == "CallCenterDoctor")
                    {
                        Requests = (from r in Model.SearchAllRequests(Type, SubType, asc, (int)RequestStatus.Ignored) where r.DoctorAssignee == UserName select r).ToList();
                        return Requests;
                    }
                    else if (user.UserType == "CallCenterAuditDoctor")
                    {
                        Requests = (from r in Model.SearchAllRequests(Type, SubType, asc, (int)RequestStatus.Ignored)
                                    where
r.AuditAssignee == UserName

                                    select r).ToList();
                        return Requests;
                    }

                    else if (UserName != null && (user.UserType == "CallCenterManager" || user.UserType == "DirectorUser"))
                    {
                        Requests = (from r in Model.SearchAllRequests(Type, SubType, asc, (int)RequestStatus.Ignored)

                                        //r.AuditAssignee == UserName &&
                                    select r).ToList();
                        return Requests;
                    }


                    else
                    {
                        return Requests;
                    }
                }
            }
            catch (Exception ex)
            {
                return null;
            }
        }
        public int GetIgnoredRequestsByUserNameCount(string UserName)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    var user = (from u in Db.CallCenterAppUsers where u.UserName == UserName select u).SingleOrDefault();
                    int Requests = 0;
                    if (user.UserType == "CallCenterUser")
                    {
                        Requests = (from r in Db.EmailApprovalRequests where r.RequstStatusID == (int)RequestStatus.Ignored && r.OperatorAssignee == UserName select r.ID).Count();
                        return Requests;
                    }
                    else if (user.UserType == "CallCenterDoctor")
                    {
                        Requests = (from r in Db.EmailApprovalRequests where r.RequstStatusID == (int)RequestStatus.Ignored && r.DoctorAssignee == UserName select r.ID).Count();
                        return Requests;
                    }
                    else if (user.UserType == "CallCenterAuditDoctor")
                    {
                        Requests = (from r in Db.EmailApprovalRequests
                                    where
                                  r.RequstStatusID == (int)RequestStatus.Ignored && r.AuditAssignee == UserName

                                    select r.ID).Count();
                        return Requests;
                    }

                    else if (UserName != null && (user.UserType == "CallCenterManager" || user.UserType == "DirectorUser"))
                    {
                        Requests = (from r in Db.EmailApprovalRequests
                                    where r.RequstStatusID == (int)RequestStatus.Ignored

                                    //r.AuditAssignee == UserName &&
                                    select r.ID).Count();
                        return Requests;
                    }


                    else
                    {
                        return Requests;
                    }
                }
            }
            catch (Exception ex)
            {
                return 0;
            }
        }
        public int GetPendingMobileRequestsCount()
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    var RequestCount = Db.ClaimsApprovals.Where(p => p.ReqStatus == "PendingApproval").Count();
                    return RequestCount;
                }
            }
            catch (Exception ex)
            {
                return 0;
            }
        }
        public int GetAllPendingOperator()
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    int Requests = 0;

                    Requests = (from r in Db.EmailApprovalRequests
                                where r.RequstStatusID == (int)RequestStatus.NewAutoGenerated
                                select r.ID).Count();
                    return Requests;

                }
            }
            catch (Exception ex)
            {
                return 0;
            }
        }
        public int GetAllPendingDoctors()
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    int Requests = 0;

                    Requests = (from r in Db.EmailApprovalRequests
                                where r.RequstStatusID == (int)RequestStatus.PendingDoctorsAssign

                                select r.ID).Count();
                    return Requests;

                }
            }
            catch (Exception ex)
            {
                return 0;
            }
        }
        public int GetAllPendingAudit()
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    int Requests = 0;

                    Requests = (from r in Db.EmailApprovalRequests
                                where r.RequstStatusID == (int)RequestStatus.PendingAuditAssign

                                select r.ID).Count();
                    return Requests;

                }
            }
            catch (Exception ex)
            {
                return 0;
            }
        }
        public int GetAllAssignedOperator()
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    int Requests = 0;

                    Requests = (from r in Db.EmailApprovalRequests
                                where r.RequstStatusID == (int)RequestStatus.AssignedByOpeartor


                                select r.ID).Count();
                    return Requests;

                }
            }
            catch (Exception ex)
            {
                return 0;
            }
        }
        public int GetAllAssignedDoctor()
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    int Requests = 0;

                    Requests = (from r in Db.EmailApprovalRequests
                                where r.RequstStatusID == (int)RequestStatus.AssignedByDoctor
                                || r.RequstStatusID == (int)RequestStatus.PendingTechnicalApproveByDoctor
                                || r.RequstStatusID == (int)RequestStatus.EndTechnicalApproveByDoctor


                                select r.ID).Count();
                    return Requests;

                }
            }
            catch (Exception ex)
            {
                return 0;
            }
        }
        public int GetAllAssignedAudit()
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    int Requests = 0;

                    Requests = (from r in Db.EmailApprovalRequests
                                where r.RequstStatusID == (int)RequestStatus.AssignedByAudit
                                   || r.RequstStatusID == (int)RequestStatus.PendingTechnicalApproveByAudit
                                || r.RequstStatusID == (int)RequestStatus.EndTechnicalApproveByAudit
                                select r.ID).Count();
                    return Requests;

                }
            }
            catch (Exception ex)
            {
                return 0;
            }
        }

        //public int ShowAllNewOnlineApprovalsCount(int Status)
        //{
        //    using (PhNetworkEntities Db = new PhNetworkEntities())
        //    {

        //       return Convert.ToInt32( Db.coun(Status));
        //            }
        //}
        public int? ShowMyOnlineApprovals(int Status,string UserName)
        {
            using (PhNetworkEntities Db = new PhNetworkEntities())
            {
              // var x = Db.SP_MyOnlineApprovals_CountRequestsByStatus(Status, UserName).FirstOrDefault();

                return Db.SP_MyOnlineApprovals_CountRequestsByStatus(Status, UserName).FirstOrDefault();
            }
        }

        public int? ShowMyAssignedOnlineApprovals( string UserName)
        {
            using (PhNetworkEntities Db = new PhNetworkEntities())
            {
                // var x = Db.SP_MyOnlineApprovals_CountRequestsByStatus(Status, UserName).FirstOrDefault();

                return Db.SP_MyAssignedOnlineApprovalsReuestsCount(UserName).FirstOrDefault();
            }
        }

        public int? ShowNewOnlineApprovals(int Status)
        {
            using (PhNetworkEntities Db = new PhNetworkEntities())
            {
                // var x = Db.SP_MyOnlineApprovals_CountRequestsByStatus(Status, UserName).FirstOrDefault();

                return Db.SP_OnlineApprovals_CountRequestsByStatus(Status).FirstOrDefault();
            }
        }






        public int GetAllRequestCount()
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    int Requests = 0;

                    Requests = (from r in Db.EmailApprovalRequests
                                select r.ID).Count();
                    return Requests;

                }
            }
            catch (Exception ex)
            {
                return 0;
            }
        }
        public void DeleteAttach(List<int> ListOfDeleted)
        {
            try
            {
                using (PhNetworkEntities Db = new PhNetworkEntities())
                {
                    List<EmailRequestAttachmentsDetail> listofAttachement = new List<EmailRequestAttachmentsDetail>();
                    foreach (var item in ListOfDeleted)
                    {
                        EmailRequestAttachmentsDetail Attachment = (from u in Db.EmailRequestAttachmentsDetails where u.ID == item select u).SingleOrDefault();
                        Attachment.IsDeleted = true;

                        listofAttachement.Add(Attachment);


                    }
                    Db.SaveChanges();

                }
            }
            catch { }
        }

        public void UpdateLoginAndLogOut(int UserID, int logtype, string MacAdress)
        {
            using (PhNetworkEntities Db = new PhNetworkEntities())
            {
                var User = (from r in Db.CallCenterAppUsers where r.UserID == UserID select r).SingleOrDefault();
                if (logtype == (int)LogType.LogIn)
                {
                    User.IsActive = true;
                    User.MACAddress = MacAdress;
                }
                else if (logtype == (int)LogType.LogOut)
                {
                    User.IsActive = false;
                    User.MACAddress = "";
                }

                Db.SaveChanges();
            }
        }

        public ActivityLogsListViewModel GetActivityRportByDateRange(DateTime DateFrom, DateTime DateTo)
        {
            using (PhNetworkEntities Db = new PhNetworkEntities())
            {
                List<OperatorsActivityLogViewModel> OperatorsList = new List<OperatorsActivityLogViewModel>();
                List<DoctorActivityLogViewModel> DoctorsList = new List<DoctorActivityLogViewModel>();
                List<AuditsActivityLogViewModel> AuditList = new List<AuditsActivityLogViewModel>();
                ActivityLogsListViewModel ActivityLogs = new ActivityLogsListViewModel();
                List<DoctorAuditActivityViewModel> FinalActivityForDoctor = new List<DoctorAuditActivityViewModel>();
                List<DoctorAuditActivityViewModel> FinalActivityForAudit = new List<DoctorAuditActivityViewModel>();


                var Operators = Db.SP_GetOperatorActivityReportByDateRange(DateFrom, DateTo);
                foreach (var item in Operators)
                {
                    OperatorsActivityLogViewModel temp = new OperatorsActivityLogViewModel();
                    temp.OperatorAsignee = item.OperatorAssignee;
                    temp.NumberOfTickets = item.NumberOfTickets;
                    temp.AverageTicketTime = TimeSpan.FromSeconds((double)item.AverageTicketTime).ToString(@"hh\:mm\:ss") + " (HH:MM:SS)";

                    OperatorsList.Add(temp);
                }

                var Doctors = Db.SP_GetDoctorActivityReportByDateRange(DateFrom, DateTo);
                foreach (var item in Doctors)
                {
                    DoctorActivityLogViewModel temp = new DoctorActivityLogViewModel();
                    temp.DoctorAsignee = item.DoctorAssignee;
                    temp.NumberOfTickets = item.NumberOfTickets;
                    temp.AverageTicketTime = item.AverageTicketTime;
                    temp.ApprovalCategoryID = item.ApprovalCategoryID;



                    DoctorsList.Add(temp);
                }
                var GrouppedByDoctorsList = DoctorsList.GroupBy(p => p.DoctorAsignee).ToList();

                foreach (var item in GrouppedByDoctorsList)
                {
                    int? TotalInpatient = item.Where(p => p.ApprovalCategoryID == (int)TicketCategory.Inpatient).Select(p => p.NumberOfTickets).SingleOrDefault();
                    int? TotalOutpatient = item.Where(p => p.ApprovalCategoryID == (int)TicketCategory.Outpatient).Select(p => p.NumberOfTickets).SingleOrDefault();
                    int? ToltalMedication = item.Where(p => p.ApprovalCategoryID == (int)TicketCategory.Medication).Select(p => p.NumberOfTickets).SingleOrDefault();

                    int? AvgInpatient = Convert.ToInt32(item.Where(p => p.ApprovalCategoryID == (int)TicketCategory.Inpatient).Select(p => p.AverageTicketTime).SingleOrDefault());
                    int? AvgOutPatient = Convert.ToInt32(item.Where(p => p.ApprovalCategoryID == (int)TicketCategory.Outpatient).Select(p => p.AverageTicketTime).SingleOrDefault());
                    int? AvgMedication = Convert.ToInt32(item.Where(p => p.ApprovalCategoryID == (int)TicketCategory.Medication).Select(p => p.AverageTicketTime).SingleOrDefault());

                    int Counter = 3;

                    if (TotalInpatient == null)
                    {
                        TotalInpatient = 0;
                        Counter -= 1;
                    }
                    if (TotalOutpatient == null)
                    {
                        TotalOutpatient = 0;
                        Counter -= 1;
                    }
                    if (ToltalMedication == null)
                    {
                        ToltalMedication = 0;
                        Counter -= 1;
                    }


                    if (AvgInpatient == null)
                    {
                        AvgInpatient = 0;

                    }
                    if (AvgOutPatient == null)
                    {
                        AvgOutPatient = 0;

                    }
                    if (AvgMedication == null)
                    {
                        AvgMedication = 0;

                    }

                    var x = item.GroupBy(p => p.ApprovalCategoryID);
                    DoctorAuditActivityViewModel temp = new DoctorAuditActivityViewModel
                    {

                        DoctorAuditName = item.Key,
                        TotalNumberOfOutPatientRequests = TotalOutpatient,
                        TotalNumberOfInpatientRequests = TotalInpatient,
                        TotalNumberOfMedicationRequests = ToltalMedication,
                        AvgOutpatientDuration = TimeSpan.FromSeconds((double)AvgOutPatient).ToString(@"hh\:mm\:ss") + " (HH:MM:SS)",
                        AvgInpatientDuration = TimeSpan.FromSeconds((double)AvgInpatient).ToString(@"hh\:mm\:ss") + " (HH:MM:SS)",
                        AvgMedicationDuration = TimeSpan.FromSeconds((double)AvgMedication).ToString(@"hh\:mm\:ss") + " (HH:MM:SS)",
                        TotalNumberOfTickets = TotalInpatient + TotalOutpatient + ToltalMedication,
                        TotalAvgDuration = TimeSpan.FromSeconds(((double)AvgInpatient + (double)AvgOutPatient + (double)AvgMedication) / Counter).ToString(@"hh\:mm\:ss") + " (HH:MM:SS)"


                    };
                    FinalActivityForDoctor.Add(temp);

                }
                var Audit = Db.SP_GetAuditActivityReportByDateRange(DateFrom, DateTo);

                foreach (var item in Audit)
                {
                    AuditsActivityLogViewModel temp = new AuditsActivityLogViewModel();
                    temp.AuditAsignee = item.AuditAssignee;
                    temp.NumberOfTickets = item.NumberOfTickets;
                    temp.AverageTicketTime = item.AverageTicketTime;
                    temp.ApprovalCategoryID = item.ApprovalCategoryID;
                    AuditList.Add(temp);
                }

                var GrouppedByAuditList = AuditList.GroupBy(p => p.AuditAsignee).ToList();

                foreach (var item in GrouppedByAuditList)
                {
                    int? TotalInpatient = item.Where(p => p.ApprovalCategoryID == (int)TicketCategory.Inpatient).Select(p => p.NumberOfTickets).SingleOrDefault();
                    int? TotalOutpatient = item.Where(p => p.ApprovalCategoryID == (int)TicketCategory.Outpatient).Select(p => p.NumberOfTickets).SingleOrDefault();
                    int? ToltalMedication = item.Where(p => p.ApprovalCategoryID == (int)TicketCategory.Medication).Select(p => p.NumberOfTickets).SingleOrDefault();

                    int? AvgInpatient = Convert.ToInt32(item.Where(p => p.ApprovalCategoryID == (int)TicketCategory.Inpatient).Select(p => p.AverageTicketTime).SingleOrDefault());
                    int? AvgOutPatient = Convert.ToInt32(item.Where(p => p.ApprovalCategoryID == (int)TicketCategory.Outpatient).Select(p => p.AverageTicketTime).SingleOrDefault());
                    int? AvgMedication = Convert.ToInt32(item.Where(p => p.ApprovalCategoryID == (int)TicketCategory.Medication).Select(p => p.AverageTicketTime).SingleOrDefault());

                    int Counter = 3;

                    if (TotalInpatient == null)
                    {
                        TotalInpatient = 0;
                        Counter -= 1;
                    }
                    if (TotalOutpatient == null)
                    {
                        TotalOutpatient = 0;
                        Counter -= 1;
                    }
                    if (ToltalMedication == null)
                    {
                        ToltalMedication = 0;
                        Counter -= 1;
                    }


                    if (AvgInpatient == null)
                    {
                        AvgInpatient = 0;

                    }
                    if (AvgOutPatient == null)
                    {
                        AvgOutPatient = 0;

                    }
                    if (AvgMedication == null)
                    {
                        AvgMedication = 0;

                    }

                    var x = item.GroupBy(p => p.ApprovalCategoryID);
                    DoctorAuditActivityViewModel temp = new DoctorAuditActivityViewModel
                    {

                        DoctorAuditName = item.Key,
                        TotalNumberOfOutPatientRequests = TotalOutpatient,
                        TotalNumberOfInpatientRequests = TotalInpatient,
                        TotalNumberOfMedicationRequests = ToltalMedication,
                        AvgOutpatientDuration = TimeSpan.FromSeconds((double)AvgOutPatient).ToString(@"hh\:mm\:ss") + " (HH:MM:SS)",
                        AvgInpatientDuration = TimeSpan.FromSeconds((double)AvgInpatient).ToString(@"hh\:mm\:ss") + " (HH:MM:SS)",
                        AvgMedicationDuration = TimeSpan.FromSeconds((double)AvgMedication).ToString(@"hh\:mm\:ss") + " (HH:MM:SS)",
                        TotalNumberOfTickets = TotalInpatient + TotalOutpatient + ToltalMedication,
                        TotalAvgDuration = TimeSpan.FromSeconds(((double)AvgInpatient + (double)AvgOutPatient + (double)AvgMedication) / Counter).ToString(@"hh\:mm\:ss") + " (HH:MM:SS)"


                    };
                    FinalActivityForAudit.Add(temp);

                }

                ActivityLogs.OperatorsActivityLog = OperatorsList;
                ActivityLogs.DoctorsActivityLog = FinalActivityForDoctor;
                ActivityLogs.AuditActivityLog = FinalActivityForAudit;

                return ActivityLogs;
            }
        }

        public string GetMacAdress()
        {
            string macAddress = "";
            try
            {
                macAddress = (from nic in NetworkInterface.GetAllNetworkInterfaces() where nic.OperationalStatus == OperationalStatus.Up select nic.GetPhysicalAddress().ToString()).FirstOrDefault();
                return macAddress;
            }
            catch { }
            return macAddress;


        }


        public void ExportActivityLogExcel()
        {

        }
    }
}